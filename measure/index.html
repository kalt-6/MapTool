<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculate the distance between two points on a global map.">
    <title>Distance Calculator</title>
    
    <!-- CORRECTED FAVICON PATH: Go up one level (../) to find logo.png -->
    <link rel="icon" type="image/png" href="../logo.png">

    <!-- Performance Preconnects -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://basemaps.cartocdn.com">
    <link rel="preconnect" href="https://nominatim.openstreetmap.org">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; background-color: #111; }
        
        /* UI Components */
        .glass-panel {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.8), 0 2px 4px -1px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* Leaflet Overrides */
        .leaflet-bar a { background-color: #0a0a0a !important; color: #e5e5e5 !important; border-bottom: 1px solid #262626 !important; }
        .leaflet-bar a:hover { background-color: #262626 !important; }
        .leaflet-container .leaflet-control-attribution {
            background: rgba(0, 0, 0, 0.6) !important; color: #666 !important; font-size: 11px; border-radius: 4px 0 0 0;
        }
        .leaflet-container .leaflet-control-attribution a { color: #888 !important; text-decoration: none; }
        .leaflet-container .leaflet-control-attribution a:hover { color: #ccc !important; text-decoration: underline; }
        
        /* Loaders */
        .loader {
            border: 2px solid #e5e5e5; border-top: 2px solid #3b82f6; border-radius: 50%;
            width: 12px; height: 12px; animation: spin 1s linear infinite;
        }
        .loader-red { border-top-color: #ef4444; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-black">

    <div id="map"></div>

    <div class="absolute top-4 left-4 z-[1000] w-full max-w-sm px-2 pointer-events-none">
        <div class="glass-panel rounded-xl p-4 pointer-events-auto shadow-2xl">
            
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-lg font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                    MapTool
                </h1>
                <button onclick="resetMap()" aria-label="Reset Map" class="text-[10px] font-bold text-neutral-400 border border-neutral-600 hover:border-red-500 hover:text-red-500 hover:bg-red-900/20 px-3 py-1 rounded transition-all">
                    Reset
                </button>
            </div>

            <!-- Input 1 (Blue) -->
            <div class="mb-3 relative group">
                <div class="absolute left-3.5 top-3 w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></div>
                <input type="text" id="input1" aria-label="Location A" placeholder="Point A (e.g., New York)" class="w-full pl-8 pr-16 py-2 bg-neutral-900/50 border border-neutral-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm text-white placeholder-neutral-500 focus:bg-neutral-900">
                <button id="btn1" aria-label="Find Location A" class="absolute right-1.5 top-1.5 bg-white hover:bg-neutral-200 text-black text-[10px] font-bold px-2 py-1.5 rounded transition-colors shadow-lg shadow-black/20">
                    Find
                </button>
            </div>

            <!-- Input 2 (Red) -->
            <div class="mb-4 relative group">
                <div class="absolute left-3.5 top-3 w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                <input type="text" id="input2" aria-label="Location B" placeholder="Point B (e.g., London)" class="w-full pl-8 pr-16 py-2 bg-neutral-900/50 border border-neutral-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500 transition-all text-sm text-white placeholder-neutral-500 focus:bg-neutral-900">
                <button id="btn2" aria-label="Find Location B" class="absolute right-1.5 top-1.5 bg-white hover:bg-neutral-200 text-black text-[10px] font-bold px-2 py-1.5 rounded transition-colors shadow-lg shadow-black/20">
                    Find
                </button>
            </div>

            <!-- Results Info -->
            <div id="resultPanel" class="pt-4 border-t border-white/10" aria-live="polite">
                <div class="flex justify-between items-center">
                    <h2 class="text-xs font-bold text-neutral-400 uppercase tracking-wide">Distance</h2>
                    <div class="flex items-center gap-2 text-sm font-bold text-white bg-neutral-800 border border-neutral-700 px-3 py-1.5 rounded-lg select-none font-mono">
                        <span id="distanceText">0 miles</span>
                    </div>
                </div>
            </div>
            
            <!-- Error Toast -->
            <div id="errorMessage" role="alert" class="hidden mt-3 text-xs text-red-400 bg-red-950/30 p-2 rounded border border-red-900/50 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="errorText">Location not found.</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            POS_1: [40.71, -74.00], POS_2: [34.05, -118.24],
            ZOOM: 2,
            TILE: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            R_MI: 3958.8, R_KM: 6371,
            TO_RAD: Math.PI / 180, TO_DEG: 180 / Math.PI
        };

        let map, allPolylines;
        const markers1 = [], markers2 = [];
        const els = {};

        document.addEventListener('DOMContentLoaded', () => {
            ['input1', 'btn1', 'input2', 'btn2', 'distanceText', 'errorMessage', 'errorText'].forEach(id => els[id] = document.getElementById(id));
            initMap();
            createMarkers(CONFIG.POS_1, '#3B82F6', markers1);
            createMarkers(CONFIG.POS_2, '#EF4444', markers2);
            setupEvents();
            refresh();
        });

        function initMap() {
            map = L.map('map', {
                worldCopyJump: true, minZoom: 1.4, zoomControl: false,
                maxBounds: [[-90, -Infinity], [90, Infinity]], maxBoundsViscosity: 1.0
            }).setView([20, 0], CONFIG.ZOOM);

            L.tileLayer(CONFIG.TILE, {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd', maxZoom: 20
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);
            allPolylines = L.layerGroup().addTo(map);
        }

        function createIcon(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36" fill="${color}" stroke="white" stroke-width="1.5" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
            return L.divIcon({ html: svg, className: '', iconSize: [36, 36], iconAnchor: [18, 36] });
        }

        function createMarkers(latlng, color, arr) {
            const icon = createIcon(color);
            for (let i = -3; i <= 3; i++) {
                const m = L.marker([latlng[0], latlng[1] + (i * 360)], { draggable: true, icon }).addTo(map);
                m.on('drag', (e) => onDrag(e, arr));
                arr.push(m);
            }
        }

        function onDrag(e, family) {
            const { lat, lng } = e.target.getLatLng();
            const clampedLat = Math.max(-85, Math.min(85, lat));
            let baseLng = lng;
            while (baseLng > 180) baseLng -= 360;
            while (baseLng < -180) baseLng += 360;

            family.forEach((m, i) => m.setLatLng([clampedLat, baseLng + ((i - 3) * 360)]));
            refresh();
        }

        function getPath(l1, l2) {
            const points = [];
            let lon2 = l2.lng;
            const diff = l2.lng - l1.lng;
            
            if (diff > 180) lon2 -= 360;
            else if (diff < -180) lon2 += 360;

            const lat1 = l1.lat * CONFIG.TO_RAD, lon1 = l1.lng * CONFIG.TO_RAD;
            const lat2 = l2.lat * CONFIG.TO_RAD, lon2R = lon2 * CONFIG.TO_RAD;
            const d = Math.acos(Math.sin(lat1) * Math.sin(lat2) + Math.cos(lat1) * Math.cos(lat2) * Math.cos(lon2R - lon1));

            if (Math.abs(d) < 1e-6) return [l1, l2];

            let lastLon = null;
            for (let i = 0; i <= 100; i++) {
                const f = i / 100, A = Math.sin((1 - f) * d) / Math.sin(d), B = Math.sin(f * d) / Math.sin(d);
                const x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2R);
                const y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2R);
                const z = A * Math.sin(lat1) + B * Math.sin(lat2);
                
                let lon = Math.atan2(y, x) * CONFIG.TO_DEG;
                if (lastLon !== null) {
                    if (lon - lastLon > 180) lon -= 360;
                    else if (lastLon - lon > 180) lon += 360;
                }
                points.push(L.latLng(Math.atan2(z, Math.sqrt(x*x + y*y)) * CONFIG.TO_DEG, lon));
                lastLon = lon;
            }
            return points;
        }

        function refresh() {
            allPolylines.clearLayers();
            const p1 = markers1[0].getLatLng(), p2 = markers2[0].getLatLng();
            const main = getPath(p1, p2);
            const opts = { color: '#FFFFFF', weight: 3, opacity: 0.7, dashArray: '5, 10' };

            for (let i = -3; i <= 3; i++) {
                L.polyline(main.map(p => L.latLng(p.lat, p.lng + (i * 360))), opts).addTo(allPolylines);
            }

            // Distance Calc
            const dLat = (p2.lat - p1.lat) * CONFIG.TO_RAD, dLon = (p2.lng - p1.lng) * CONFIG.TO_RAD;
            const a = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(p1.lat * CONFIG.TO_RAD) * Math.cos(p2.lat * CONFIG.TO_RAD);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            els.distanceText.textContent = `${Math.round(CONFIG.R_MI * c).toLocaleString('en-US')} mi (${Math.round(CONFIG.R_KM * c).toLocaleString('en-US')} km)`;
        }

        function setupEvents() {
            const bind = (inp, btn, fam) => {
                btn.addEventListener('click', () => search(inp, btn, fam));
                inp.addEventListener('keydown', (e) => e.key === 'Enter' && search(inp, btn, fam));
            };
            bind(els.input1, els.btn1, markers1);
            bind(els.input2, els.btn2, markers2);
        }

        async function search(inp, btn, family) {
            const q = inp.value.trim();
            if (!q) return;

            const txt = btn.innerText;
            btn.innerHTML = `<div class="loader ${btn.id === 'btn2' ? 'loader-red' : ''}"></div>`;
            btn.disabled = true;
            els.errorMessage.classList.add('hidden');

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
                const data = await res.json();

                if (data?.[0]) {
                    const { lat, lon, display_name } = data[0];
                    const nLat = parseFloat(lat), nLon = parseFloat(lon);
                    family.forEach((m, i) => m.setLatLng([nLat, nLon + ((i - 3) * 360)]));
                    inp.value = display_name.split(',')[0];
                    refresh();
                    
                    const bounds = L.latLngBounds(getPath(markers1[0].getLatLng(), markers2[0].getLatLng()));
                    if (bounds.isValid()) map.flyToBounds(bounds, { padding: [100, 100], maxZoom: 6 });
                } else {
                    showError('Location not found.');
                }
            } catch (e) { showError('Search failed.'); } 
            finally { btn.innerText = txt; btn.disabled = false; }
        }

        function showError(msg) {
            els.errorText.textContent = msg;
            els.errorMessage.classList.remove('hidden');
            setTimeout(() => els.errorMessage.classList.add('hidden'), 3000);
        }

        function resetMap() {
            els.input1.value = els.input2.value = '';
            [markers1, markers2].forEach((fam, idx) => {
                const pos = idx === 0 ? CONFIG.POS_1 : CONFIG.POS_2;
                fam.forEach((m, i) => m.setLatLng([pos[0], pos[1] + ((i - 3) * 360)]));
            });
            refresh();
            map.setView([20, 0], CONFIG.ZOOM);
        }
    </script>
</body>
</html>
